#!/bin/bash

# Installation:
#
#   1) Make sure you can execute "jupyter lab" on the remote server after logging in
#   2) On your local machine, put this script in a folder that's on your path.
#      I use ~/bin.
#   3) Make the script executable: chmod +x ~/bin/remotejupyter
#
# Usage:
#
#  remotejupyter username@server
#
# For example, I use "remotejupyter cdg4@scotty.princeton.edu"
#
# Author: Daniel Greenidge <daniel@danielgreenidge.com>

# SSH alias of the server on which you want to run the Jupyter notebook
SERVER_ALIAS=$1

if [ -z $SERVER_ALIAS ]; then
    echo "    Usage: remotejupyter username@server"
    echo "    Make sure that \"jupyter lab\" and \"tmux\" are installed on the server"
    exit
fi

echo "Connecting to $SERVER_ALIAS"

# Enable ssh multiplexing
SSH_OPTIONS="-o ControlMaster=auto -o ControlPath=$TMPDIR%r@%h-%p \
-o ControlPersist=600"

echo "Starting ssh master connection"
# Start ssh master connection
ssh $SSH_OPTIONS -fN $SERVER_ALIAS

echo "Searching for unused port on remote server"
JUPYTERLAB_PORT=$(ssh $SSH_OPTIONS $SERVER_ALIAS "\
JUPYTERLAB_PORT=8888;\
until [ -z \"\$(netstat -atn | grep 127.0.0.1.\$JUPYTERLAB_PORT)\" ]; do\
    JUPYTERLAB_PORT=\$((JUPYTERLAB_PORT + 1));\
done;\
echo \$JUPYTERLAB_PORT")
echo "Using port $JUPYTERLAB_PORT"

echo "Starting jupyter lab session on remote server"
UNIQUE_SESSION_NAME="jupyterlab-$(uuidgen)"
ssh $SSH_OPTIONS -T -f $SERVER_ALIAS "\
tmux new -d -s \"$UNIQUE_SESSION_NAME\" \"jupyter lab --port=$JUPYTERLAB_PORT\""
echo "Established session $UNIQUE_SESSION_NAME"

echo "Starting ssh tunnel"
ssh $SSH_OPTIONS -L $JUPYTERLAB_PORT:localhost:$JUPYTERLAB_PORT $SERVER_ALIAS &

echo "Logging in to remote server"
ssh $SSH_OPTIONS $SERVER_ALIAS -tt "tmux attach -t $UNIQUE_SESSION_NAME"

TMUX_SESSIONS=$(
    ssh $SSH_OPTIONS $SERVER_ALIAS "tmux list-sessions" | grep --color=never jupyterlab
)
if [ ! -z "$TMUX_SESSIONS" ]; then
    echo "WARNING: The following tmux sessions are still alive:"
    echo "$TMUX_SESSIONS"
    echo "You might need to log in and clean these up manually"
fi

echo "Cleaning up ssh master connection and all slaves"
ssh $SSH_OPTIONS -O exit $SERVER_ALIAS
